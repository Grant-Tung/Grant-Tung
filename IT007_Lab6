#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>

#define MAX_LINE 80
#define MAX_ARGS 10

// Ham xu ly tin hieu Ctrl+C
void handle_sigint(int signo) {
    printf("\nit007sh> ");
    fflush(stdout);
}

int main() {
    char input[MAX_LINE];
    char *args[MAX_ARGS];
    int should_run = 1;

    // Bat tin hieu Ctrl+C
    signal(SIGINT, handle_sigint);

    while (should_run) {
        printf("it007sh> ");
        fflush(stdout);
        // Doc lenh
        if (fgets(input, MAX_LINE, stdin) == NULL) {
            break; 
        }
        // Xoa ky tu xuong dong o cuoi
        input[strlen(input) - 1] = '\0';
        // Neu khong nhap gi thi bo qua
        if (strlen(input) == 0) continue;
        // Kiem tra lenh exit
        if (strcmp(input, "exit") == 0) {
            should_run = 0;
            continue;
        }
        // Xu ly Pipe (chia lenh theo dau |)
        char *commands[10]; // Mang chua cac lenh
        int n_cmds = 0;
        
        char *token = strtok(input, "|");
        while (token != NULL) {
            commands[n_cmds++] = token;
            token = strtok(NULL, "|");
        }

        // Thiet lap pipe
        int pipe_fd[2];
        int in_fd = 0; // Dau vao ban dau la stdin (0)
        for (int i = 0; i < n_cmds; i++) {
            pipe(pipe_fd); // Tao duong ong
            pid_t pid = fork();

            if (pid == 0) { // Tien trinh con
                //Xu ly Pipe dau vao
                if (in_fd != 0) {
                    dup2(in_fd, STDIN_FILENO);
                    close(in_fd);
                }

                //Xu ly Pipe dau ra
                // Neu khong phai lenh cuoi cung thi output vao pipe
                if (i < n_cmds - 1) {
                    dup2(pipe_fd[1], STDOUT_FILENO);
                }
                
                // Dong cac dau pipe du thua
                close(pipe_fd[0]); 
                close(pipe_fd[1]); 

                //Cat chuoi lay lenh va tham so
                int arg_count = 0;
                char *cmd_token = strtok(commands[i], " ");
                char *file_in = NULL;
                char *file_out = NULL;
                while (cmd_token != NULL) {
                    // Kiem tra chuyen huong
                    if (strcmp(cmd_token, "<") == 0) {
                        cmd_token = strtok(NULL, " "); // Lay ten file
                        file_in = cmd_token;
                    } 
                    else if (strcmp(cmd_token, ">") == 0) {
                        cmd_token = strtok(NULL, " "); // Lay ten file
                        file_out = cmd_token;
                    } 
                    else {
                        args[arg_count++] = cmd_token;
                    }
                    cmd_token = strtok(NULL, " ");
                }
                args[arg_count] = NULL; // Ket thuc mang doi so
                //Redirect < va >
                if (file_in) {
                    int fd = open(file_in, O_RDONLY);
                    if (fd < 0) { perror("Loi mo file input"); exit(1); }
                    dup2(fd, STDIN_FILENO);
                    close(fd);
                }

                if (file_out) {
                    int fd = open(file_out, O_WRONLY | O_CREAT | O_TRUNC, 0644);
                    if (fd < 0) { perror("Loi mo file output"); exit(1); }
                    dup2(fd, STDOUT_FILENO);
                    close(fd);
                }

                // Thuc thi 
                if (execvp(args[0], args) < 0) {
                    printf("Lenh khong ton tai: %s\n", args[0]);
                    exit(1);
                }

            } else { // Tien trinh cha
                wait(NULL); // Doi con chay xong
                
                close(pipe_fd[1]); // Dong dau ghi cua pipe hien tai
                
                // Luu dau doc de lam dau vao cho lenh tiep theo
                if (in_fd != 0) close(in_fd); // Dong dau doc cua vong lap truoc
                in_fd = pipe_fd[0]; 
            }
        }
    }
    return 0;
}
